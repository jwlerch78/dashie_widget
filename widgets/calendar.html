<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendar Widget</title>
  
  <!-- Toast UI Calendar CSS -->
  <link rel="stylesheet" href="https://uicdn.toast.com/calendar/latest/toastui-calendar.min.css" />
  
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: #333;
      overflow: hidden;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      color: white;
    }

    #calendar-container {
      width: 100%;
      height: 100%;
      position: relative;
      background: #333;
    }

    #calendar {
      width: 100%;
      height: calc(100% - 60px);
      background: white;
      border-radius: 8px;
      margin: 10px;
      box-sizing: border-box;
    }

    .calendar-header {
      background: #444;
      color: white;
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 8px 8px 0 0;
      margin: 10px 10px 0 10px;
      font-size: 14px;
    }

    .calendar-title {
      font-weight: bold;
      font-size: 16px;
    }

    .calendar-mode {
      background: #555;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
    }

    .status {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 12px;
      color: #999;
      background: rgba(0, 0, 0, 0.7);
      padding: 3px 6px;
      border-radius: 3px;
      z-index: 1000;
    }

    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #999;
      font-size: 14px;
      z-index: 999;
    }

    /* Override Toast UI styles for dark theme */
    .toastui-calendar {
      background: white !important;
      color: #333 !important;
    }

    .toastui-calendar-week-view-day-names {
      background: #f8f9fa !important;
    }

    .toastui-calendar-month-view-day-names {
      background: #f8f9fa !important;
    }
  </style>
</head>
<body>
  <div class="status">ðŸ“… Calendar</div>
  
  <div id="calendar-container">
    <div class="loading" id="loading">Loading calendar...</div>
    
    <div class="calendar-header" id="calendarHeader" style="display: none;">
      <div class="calendar-title" id="calendarTitle">Loading...</div>
      <div class="calendar-mode" id="calendarMode">Week</div>
    </div>
    
    <div id="calendar" style="display: none;"></div>
  </div>

  <!-- Toast UI Calendar JS -->
  <script src="https://uicdn.toast.com/calendar/latest/toastui-calendar.min.js"></script>
  
  <script>
    let calendar;
    let currentView = 'week'; // daily, week, month
    let currentDate = new Date();
    
    // Calendar configuration
    const calendars = [
      {
        id: 'calendar1',
        name: 'Main Calendar',
        url: 'https://calendar.playmetrics.com/calendars/c1334/t398340/p0/t2BDEDC4E/f/calendar.ics',
        color: '#1e3a8a', // Navy blue
        backgroundColor: '#1e3a8a',
        borderColor: '#1e3a8a'
      },
      {
        id: 'calendar2', 
        name: 'Secondary Calendar',
        url: 'https://calendar.playmetrics.com/calendars/c379/t346952/p0/tEB6F077C/f/calendar.ics',
        color: '#166534', // Green
        backgroundColor: '#166534',
        borderColor: '#166534'
      }
    ];

    // Initialize calendar
    function initializeCalendar() {
      try {
        // Set to Monday start
        const monday = getStartOfWeek(currentDate);
        currentDate = monday;
        
        calendar = new tui.Calendar('#calendar', {
          defaultView: currentView,
          useCreationPopup: false,
          useDetailPopup: false,
          calendars: calendars,
          week: {
            startDayOfWeek: 1, // Monday = 1
            dayNames: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
            narrowWeekend: false,
            workweek: false
          },
          month: {
            startDayOfWeek: 1, // Monday = 1
            dayNames: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
            visibleWeeksCount: 6
          },
          template: {
            time: function(schedule) {
              return `<span style="color: white;">${schedule.title}</span>`;
            }
          }
        });

        // Set initial date
        calendar.setDate(currentDate);
        
        // Show calendar
        document.getElementById('loading').style.display = 'none';
        document.getElementById('calendarHeader').style.display = 'flex';
        document.getElementById('calendar').style.display = 'block';
        
        updateCalendarHeader();
        loadCalendarData();
        
        console.log('ðŸ“… Calendar initialized in', currentView, 'view');
        
      } catch (error) {
        console.error('ðŸ“… Failed to initialize calendar:', error);
        document.getElementById('loading').textContent = 'Failed to load calendar';
      }
    }

    // Get start of week (Monday)
    function getStartOfWeek(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
      return new Date(d.setDate(diff));
    }

    // Update calendar header
    function updateCalendarHeader() {
      const titleEl = document.getElementById('calendarTitle');
      const modeEl = document.getElementById('calendarMode');
      
      const options = { 
        year: 'numeric', 
        month: 'long',
        ...(currentView === 'daily' ? { day: 'numeric' } : {})
      };
      
      titleEl.textContent = currentDate.toLocaleDateString('en-US', options);
      modeEl.textContent = currentView.charAt(0).toUpperCase() + currentView.slice(1);
    }

    // Navigation functions
    function navigateCalendar(direction) {
      const currentDateObj = calendar.getDate();
      let newDate = new Date(currentDateObj);
      
      switch(currentView) {
        case 'daily':
          newDate.setDate(newDate.getDate() + (direction === 'next' ? 1 : -1));
          break;
        case 'week':
          newDate.setDate(newDate.getDate() + (direction === 'next' ? 7 : -7));
          break;
        case 'month':
          newDate.setMonth(newDate.getMonth() + (direction === 'next' ? 1 : -1));
          break;
      }
      
      currentDate = newDate;
      calendar.setDate(newDate);
      updateCalendarHeader();
      
      console.log('ðŸ“… Navigated', direction, 'to', newDate.toDateString());
    }

    // Change view mode
    function changeView(newView) {
      if (['daily', 'week', 'month'].includes(newView)) {
        currentView = newView;
        calendar.changeView(newView);
        updateCalendarHeader();
        console.log('ðŸ“… Changed to', newView, 'view');
      }
    }

    // Cycle through view modes
    function cycleView(direction) {
      const views = ['daily', 'week', 'month'];
      const currentIndex = views.indexOf(currentView);
      let newIndex;
      
      if (direction === 'forward') {
        newIndex = (currentIndex + 1) % views.length;
      } else {
        newIndex = (currentIndex - 1 + views.length) % views.length;
      }
      
      changeView(views[newIndex]);
    }

    // Load calendar data from ICS feeds
    async function loadCalendarData() {
      console.log('ðŸ“… Loading calendar data...');
      
      for (const cal of calendars) {
        try {
          // For demo purposes, create some sample events
          // In production, you'd parse the ICS feeds
          const sampleEvents = createSampleEvents(cal);
          calendar.createEvents(sampleEvents);
          console.log('ðŸ“… Loaded events for', cal.name);
        } catch (error) {
          console.error('ðŸ“… Failed to load calendar', cal.name, error);
        }
      }
    }

    // Create sample events (replace with ICS parser)
    function createSampleEvents(cal) {
      const events = [];
      const today = new Date();
      
      // Create 10 sample events over the next month
      for (let i = 0; i < 10; i++) {
        const eventDate = new Date(today);
        eventDate.setDate(today.getDate() + (i * 3));
        
        const endDate = new Date(eventDate);
        endDate.setHours(eventDate.getHours() + 2);
        
        events.push({
          id: `${cal.id}-event-${i}`,
          calendarId: cal.id,
          title: `${cal.name} Event ${i + 1}`,
          start: eventDate,
          end: endDate,
          category: 'time',
          backgroundColor: cal.backgroundColor,
          borderColor: cal.borderColor,
          color: 'white'
        });
      }
      
      return events;
    }

    // D-pad Navigation
    window.addEventListener('message', (event) => {
      if (event.data && event.data.action) {
        const action = event.data.action;
        console.log('ðŸ“… Calendar widget received command:', action);
        
        switch(action) {
          case 'right':
            navigateCalendar('next');
            break;
          case 'left':
            navigateCalendar('previous');
            break;
          case 'up':
            cycleView('forward');
            break;
          case 'down':
            cycleView('backward');
            break;
          case 'enter':
            console.log('ðŸ“… Enter pressed on calendar widget');
            break;
          default:
            console.log('ðŸ“… Calendar widget ignoring command:', action);
            break;
        }
      }
    });

    // Send ready signal to parent dashboard
    window.addEventListener('load', () => {
      if (window.parent !== window) {
        window.parent.postMessage({ 
          type: 'widget-ready', 
          widget: 'calendar' 
        }, '*');
      }
    });

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(initializeCalendar, 100); // Small delay to ensure Toast UI is loaded
    });
  </script>
</body>
</html>
