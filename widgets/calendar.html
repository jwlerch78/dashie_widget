<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendar Widget</title>
  
  <!-- Toast UI Calendar CSS -->
  <link rel="stylesheet" href="https://uicdn.toast.com/calendar/latest/toastui-calendar.min.css" />
  
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: #333;
      overflow: hidden; /* No iframe scrolling */
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      color: white;
    }

    #calendar-container {
      width: 100%;
      height: 100%;
      position: relative;
      background: #333;
      overflow: hidden; /* No container scrolling */
    }

    #calendar {
      width: calc(100% - 20px);
      height: calc(100% - 70px); /* Fixed height */
      background: white;
      border-radius: 8px;
      margin: 10px;
      box-sizing: border-box;
      overflow: hidden; /* Let Toast UI handle its own scrolling */
    }

    .calendar-header {
      background: #444;
      color: white;
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 8px 8px 0 0;
      margin: 10px 10px 0 10px;
      font-size: 14px;
      height: 40px;
      box-sizing: border-box;
    }

    .calendar-title {
      font-weight: bold;
      font-size: 16px;
    }

    .calendar-mode {
      background: #555;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
    }

    .status {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 12px;
      color: #999;
      background: rgba(0, 0, 0, 0.7);
      padding: 3px 6px;
      border-radius: 3px;
      z-index: 1000;
    }

    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #999;
      font-size: 14px;
      z-index: 999;
    }

    .controls-info {
      position: absolute;
      bottom: 10px;
      left: 10px;
      font-size: 10px;
      color: #666;
      background: rgba(0, 0, 0, 0.7);
      padding: 3px 6px;
      border-radius: 3px;
      z-index: 1000;
    }

    /* Fix Toast UI calendar layout */
    .toastui-calendar {
      background: white !important;
      color: #333 !important;
      height: 100% !important;
    }

    .toastui-calendar-layout {
      height: 100% !important;
    }

    .toastui-calendar-week-view,
    .toastui-calendar-month-view,
    .toastui-calendar-daily-view {
      height: 100% !important;
    }

    /* Hide all-day section when empty */
    .toastui-calendar-week-view .toastui-calendar-allday-container {
      display: none;
    }

    .toastui-calendar-week-view .toastui-calendar-allday-container.has-events {
      display: block;
    }

    /* Ensure monthly view displays properly */
    .toastui-calendar-month-view .toastui-calendar-month-week-item {
      height: auto !important;
      min-height: 80px !important;
    }

    .toastui-calendar-month-view .toastui-calendar-month-week {
      flex: 1 !important;
    }

    /* Make week view scrollable */
    .toastui-calendar-week-view .toastui-calendar-time {
      height: 100% !important;
      overflow-y: auto !important;
    }

    .toastui-calendar-week-view .toastui-calendar-time-scroll-wrapper {
      height: 100% !important;
      overflow-y: auto !important;
    }
  </style>
</head>
<body>
  <div class="status">üìÖ Calendar</div>
  
  <div id="calendar-container">
    <div class="loading" id="loading">Loading calendar...</div>
    
    <div class="calendar-header" id="calendarHeader" style="display: none;">
      <div class="calendar-title" id="calendarTitle">Loading...</div>
      <div class="calendar-mode" id="calendarMode">Week</div>
    </div>
    
    <div id="calendar" style="display: none;"></div>
    
    <div class="controls-info">
      ‚Üê‚Üí: Navigate | ‚Üë‚Üì: Scroll Time | ,.: Change View
    </div>
  </div>

  <!-- Toast UI Calendar JS -->
  <script src="https://uicdn.toast.com/calendar/latest/toastui-calendar.min.js"></script>
  
  <script>
    let calendar;
    let currentView = 'week'; // daily, week, month
    let currentDate = new Date();
    
    // Calendar configuration
    const calendars = [
      {
        id: 'calendar1',
        name: 'Main Calendar',
        url: 'https://calendar.playmetrics.com/calendars/c1334/t398340/p0/t2BDEDC4E/f/calendar.ics',
        color: '#1e3a8a', // Navy blue
        backgroundColor: '#1e3a8a',
        borderColor: '#1e3a8a'
      },
      {
        id: 'calendar2', 
        name: 'Secondary Calendar',
        url: 'https://calendar.playmetrics.com/calendars/c379/t346952/p0/tEB6F077C/f/calendar.ics',
        color: '#166534', // Green
        backgroundColor: '#166534',
        borderColor: '#166534'
      }
    ];

    // Initialize calendar
    function initializeCalendar() {
      try {
        // Set to Monday start
        const monday = getStartOfWeek(currentDate);
        currentDate = monday;
        
        calendar = new tui.Calendar('#calendar', {
          defaultView: currentView,
          useCreationPopup: false,
          useDetailPopup: false,
          calendars: calendars,
          week: {
            startDayOfWeek: 1, // Monday = 1
            dayNames: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
            narrowWeekend: false,
            workweek: false,
            hourStart: 6, // Start at 6 AM
            hourEnd: 24,  // End at midnight
            showNowIndicator: true
          },
          month: {
            startDayOfWeek: 1, // Monday = 1
            dayNames: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
            visibleWeeksCount: 6,
            isAlways6Week: false,
            workweek: false
          },
          template: {
            time: function(schedule) {
              return `<span style="color: white;">${schedule.title}</span>`;
            }
          }
        });

        // Set initial date
        calendar.setDate(currentDate);
        
        // Show calendar
        document.getElementById('loading').style.display = 'none';
        document.getElementById('calendarHeader').style.display = 'flex';
        document.getElementById('calendar').style.display = 'block';
        
        updateCalendarHeader();
        loadCalendarData();
        
        console.log('üìÖ Calendar initialized in', currentView, 'view');
        
        // Set initial scroll position to 8 AM
        setTimeout(() => {
          scrollToTime(8);
        }, 200);
        
      } catch (error) {
        console.error('üìÖ Failed to initialize calendar:', error);
        document.getElementById('loading').textContent = 'Failed to load calendar';
      }
    }

    // Get start of week (Monday)
    function getStartOfWeek(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
      return new Date(d.setDate(diff));
    }

    // Update calendar header
    function updateCalendarHeader() {
      const titleEl = document.getElementById('calendarTitle');
      const modeEl = document.getElementById('calendarMode');
      
      const options = { 
        year: 'numeric', 
        month: 'long',
        ...(currentView === 'daily' ? { day: 'numeric' } : {})
      };
      
      titleEl.textContent = currentDate.toLocaleDateString('en-US', options);
      modeEl.textContent = currentView.charAt(0).toUpperCase() + currentView.slice(1);
    }

    // Navigation functions
    function navigateCalendar(direction) {
      const currentDateObj = calendar.getDate();
      let newDate = new Date(currentDateObj);
      
      switch(currentView) {
        case 'daily':
          newDate.setDate(newDate.getDate() + (direction === 'next' ? 1 : -1));
          break;
        case 'week':
          newDate.setDate(newDate.getDate() + (direction === 'next' ? 7 : -7));
          break;
        case 'month':
          newDate.setMonth(newDate.getMonth() + (direction === 'next' ? 1 : -1));
          break;
      }
      
      currentDate = newDate;
      calendar.setDate(newDate);
      updateCalendarHeader();
      
      console.log('üìÖ Navigated', direction, 'to', newDate.toDateString());
    }

    // Scroll to specific time (hour)
    function scrollToTime(hour) {
      if (currentView === 'week' || currentView === 'daily') {
        const timeElements = document.querySelectorAll('.toastui-calendar-time-hour');
        const targetElement = Array.from(timeElements).find(el => {
          const hourText = el.textContent || el.innerText;
          return hourText.includes(hour + ':00') || hourText.includes((hour % 12 || 12) + ':00');
        });
        
        if (targetElement) {
          targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
          console.log('üìÖ Scrolled to', hour + ':00');
        }
      }
    }

    // Scroll calendar time view
    function scrollCalendar(direction) {
      if (currentView === 'week' || currentView === 'daily') {
        const scrollContainer = document.querySelector('.toastui-calendar-time-scroll-wrapper') 
                             || document.querySelector('.toastui-calendar-time');
        
        if (scrollContainer) {
          const scrollAmount = 60; // pixels to scroll (about 1 hour)
          
          if (direction === 'up') {
            scrollContainer.scrollTop -= scrollAmount;
          } else if (direction === 'down') {
            scrollContainer.scrollTop += scrollAmount;
          }
          
          console.log('üìÖ Scrolled calendar', direction, 'by', scrollAmount, 'pixels');
        }
      } else {
        console.log('üìÖ Scrolling only available in week/daily view');
      }
    }

    // Change view mode
    function changeView(newView) {
      if (['daily', 'week', 'month'].includes(newView)) {
        currentView = newView;
        calendar.changeView(newView);
        updateCalendarHeader();
        console.log('üìÖ Changed to', newView, 'view');
        
        // Scroll to 8 AM in time views
        if (newView === 'week' || newView === 'daily') {
          setTimeout(() => scrollToTime(8), 100);
        }
      }
    }

    // Cycle through view modes (fast forward/rewind)
    function cycleView(direction) {
      const views = ['week', 'month', 'daily']; // week -> month -> daily -> week
      const currentIndex = views.indexOf(currentView);
      let newIndex;
      
      if (direction === 'forward') {
        newIndex = (currentIndex + 1) % views.length;
      } else {
        newIndex = (currentIndex - 1 + views.length) % views.length;
      }
      
      changeView(views[newIndex]);
    }

    // Hide/show all-day section based on events
    function updateAllDaySection() {
      setTimeout(() => {
        const allDayContainer = document.querySelector('.toastui-calendar-allday-container');
        const allDayEvents = document.querySelectorAll('.toastui-calendar-weekday-allday .toastui-calendar-event');
        
        if (allDayContainer) {
          if (allDayEvents.length > 0) {
            allDayContainer.classList.add('has-events');
            allDayContainer.style.display = 'block';
          } else {
            allDayContainer.classList.remove('has-events');
            allDayContainer.style.display = 'none';
          }
        }
      }, 100);
    }

    // Load calendar data from ICS feeds
    async function loadCalendarData() {
      console.log('üìÖ Loading calendar data...');
      
      for (const cal of calendars) {
        try {
          // For demo purposes, create some sample events
          // In production, you'd parse the ICS feeds
          const sampleEvents = createSampleEvents(cal);
          calendar.createEvents(sampleEvents);
          console.log('üìÖ Loaded events for', cal.name);
        } catch (error) {
          console.error('üìÖ Failed to load calendar', cal.name, error);
        }
      }
      
      updateAllDaySection();
    }

    // Create sample events (replace with ICS parser)
    function createSampleEvents(cal) {
      const events = [];
      const today = new Date();
      
      // Create events throughout the day for better scrolling demo
      for (let i = 0; i < 10; i++) {
        const eventDate = new Date(today);
        eventDate.setDate(today.getDate() + (i % 7)); // Spread over a week
        eventDate.setHours(8 + (i % 12), 0, 0, 0); // Events from 8 AM to 7 PM
        
        const endDate = new Date(eventDate);
        endDate.setHours(eventDate.getHours() + 1); // 1 hour events
        
        events.push({
          id: `${cal.id}-event-${i}`,
          calendarId: cal.id,
          title: `${cal.name.split(' ')[0]} Event ${i + 1}`,
          start: eventDate,
          end: endDate,
          category: 'time',
          backgroundColor: cal.backgroundColor,
          borderColor: cal.borderColor,
          color: 'white'
        });
      }
      
      return events;
    }

    // D-pad Navigation
    window.addEventListener('message', (event) => {
      if (event.data && event.data.action) {
        const action = event.data.action;
        console.log('üìÖ Calendar widget received command:', action);
        
        switch(action) {
          case 'right':
            navigateCalendar('next');
            break;
          case 'left':
            navigateCalendar('previous');
            break;
          case 'up':
            scrollCalendar('up');
            break;
          case 'down':
            scrollCalendar('down');
            break;
          case 'enter':
            console.log('üìÖ Enter pressed on calendar widget');
            break;
          // Handle fast forward/rewind from remote control
          case 'fastforward':
          case 'ff':
          case ',':
            cycleView('forward');
            break;
          case 'rewind':
          case 'rw':
          case '.':
            cycleView('backward');
            break;
          default:
            console.log('üìÖ Calendar widget ignoring command:', action);
            break;
        }
      }
    });

    // Also listen for direct keyboard events for PC testing
    document.addEventListener('keydown', (e) => {
      // Only handle if this widget is focused and the event isn't from message passing
      if (document.hasFocus()) {
        switch(e.key) {
          case ',':
            e.preventDefault();
            cycleView('forward');
            break;
          case '.':
            e.preventDefault();
            cycleView('backward');
            break;
        }
      }
    });

    // Send ready signal to parent dashboard
    window.addEventListener('load', () => {
      if (window.parent !== window) {
        window.parent.postMessage({ 
          type: 'widget-ready', 
          widget: 'calendar' 
        }, '*');
      }
    });

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(initializeCalendar, 100); // Small delay to ensure Toast UI is loaded
    });
  </script>
</body>
</html>
